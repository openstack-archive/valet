heat_template_version: 2015-04-30

description: Template which creates multiple types of non-valet resources.

parameters:

  avail-zone1:
    type: string
    description: 'availability zone 1'

  image1:
    type: string
    description: 'name of the image 1'

  network1:
    type: string
    description: 'name of the network 1'

  flavor1:
    type: string
    description: 'name of the flavor 1'

  flavor2:
    type: string
    description: 'name of the flavor 2'

resources:

  cscf_RSG:
    type: OS::Neutron::SecurityGroup
    properties:
      description: Allow all
      name: cscf_RSG
      rules:
        - { direction: ingress, ethertype: IPv4 }
        - { direction: egress, ethertype: IPv4 }
        - { direction: ingress, ethertype: IPv4, protocol: tcp }

  cscf_internal_network_0:
    type: OS::Neutron::Net
    properties:
      name: cscf_internal_network_0
      admin_state_up: True
      shared: False

  cscf_internal_subnet_0:
    type: OS::Neutron::Subnet
    properties:
      name: cscf_internal_subnet_0
      ip_version: 4
      network: { get_resource: cscf_internal_network_0 }
      cidr: 10.200.212.0/24
      enable_dhcp: False
      gateway_ip: null

  oam_server_group:
    type: OS::Nova::ServerGroup
    properties:
      name: oam_server_group
      policies: ["anti-affinity"]

  oam_internal_0_port_0:
    type: OS::Neutron::Port
    depends_on:
      - cscf_internal_subnet_0
    properties:
      name: oam_internal_0_port_0
      network: { get_resource: cscf_internal_network_0 }
      security_groups:
        - { get_resource: cscf_RSG }
      fixed_ips:
        - ip_address: 10.200.212.14
      allowed_address_pairs:
        - ip_address: "0.0.0.0/1"
        - ip_address: "128.0.0.0/1"
        - ip_address: "::/1"
        - ip_address: "8000::/1"

  oam_oam_0_port_1:
    type: OS::Neutron::Port
    properties:
      name: oam_oam_0_port_1
      network: { get_param: network1 }
      security_groups:
        - { get_resource: cscf_RSG }
      fixed_ips:
        - ip_address: 10.100.1.10
      allowed_address_pairs:
        - ip_address: 10.100.1.7

  oam_server_0:
    type: OS::Nova::Server
    properties:
      availability_zone: {get_param: avail-zone1}
      scheduler_hints: { group: { get_resource: oam_server_group } }
      name: oam_server_0
      flavor: {get_param: flavor1}
      image: {get_param: image1}
      networks:
        - port:  { get_resource: oam_internal_0_port_0 }
        - port:  { get_resource: oam_oam_0_port_1 }

  oam_internal_1_port_0:
    type: OS::Neutron::Port
    depends_on:
      - cscf_internal_subnet_0
    properties:
      name: oam_internal_1_port_0
      network: { get_resource: cscf_internal_network_0 }
      security_groups:
        - { get_resource: cscf_RSG }
      fixed_ips:
        - ip_address: 10.200.212.15
      allowed_address_pairs:
        - ip_address: "0.0.0.0/1"
        - ip_address: "128.0.0.0/1"
        - ip_address: "::/1"
        - ip_address: "8000::/1"

  oam_oam_1_port_1:
    type: OS::Neutron::Port
    properties:
      name: oam_oam_1_port_1
      network: {get_param: network1}
      security_groups:
        - { get_resource: cscf_RSG }
      fixed_ips:
        - ip_address: 10.100.1.11
      allowed_address_pairs:
        - ip_address: 10.100.1.7

  oam_server_1:
    type: OS::Nova::Server
    properties:
      availability_zone: {get_param: avail-zone1}
      scheduler_hints: { group: { get_resource: oam_server_group } }
      name: oam_server_1
      flavor: {get_param: flavor1}
      image: {get_param: image1}
      networks:
        - port:  { get_resource: oam_internal_1_port_0 }
        - port:  { get_resource: oam_oam_1_port_1 }

outputs:
  internal_net_id:
    description: internal network
    value: {get_resource: cscf_internal_network_0}

  cscf_security_group:
    description: cscf security group
    value: {get_resource: cscf_RSG}
